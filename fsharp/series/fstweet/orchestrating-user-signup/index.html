<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.30.2" />
  
  <meta name="description" content="Demystifying">

  
  <link rel="alternate" hreflang="en-us" href="https://www.demystifyfp.com/fsharp/series/fstweet/orchestrating-user-signup/">

  
  


  

  
  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700%7cRoboto:400,400italic,700%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  
  <link rel="stylesheet" href="/css/custom.css">
  

  

  
  <link rel="alternate" href="https://www.demystifyfp.com/index.xml" type="application/rss+xml" title="Demystify FP">
  <link rel="feed" href="https://www.demystifyfp.com/index.xml" type="application/rss+xml" title="Demystify FP">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.demystifyfp.com/fsharp/series/fstweet/orchestrating-user-signup/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@demystifyfp">
  <meta property="twitter:creator" content="@demystifyfp">
  
  <meta property="og:site_name" content="Demystify FP">
  <meta property="og:url" content="https://www.demystifyfp.com/fsharp/series/fstweet/orchestrating-user-signup/">
  <meta property="og:title" content="Orchestrating User Signup | Demystify FP">
  <meta property="og:description" content="">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2017-08-28T09:38:55&#43;05:30">
  
  <meta property="article:modified_time" content="2017-08-28T09:38:55&#43;05:30">
  

  

  <title>Orchestrating User Signup | Demystify FP</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">Demystify FP</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
            Books
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            
            <li class="nav-item">
              <a href="http://products.tamizhvendan.in/fsharp-applied">
                
                <span>F# Applied</span>
              </a>
            </li>
            
          </ul>
        </li>

        
        

        
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
            Tutorials
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            
            <li class="nav-item">
              <a href="/fsharp/series/fstweet/intro">
                
                <span>Twitter Clone in F#</span>
              </a>
            </li>
            
          </ul>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">Orchestrating User Signup</h1>

      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2017-08-28 09:38:55 &#43;0530 IST" itemprop="datePublished">
      Mon, Aug 28, 2017
    </time>
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    13 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="https://www.demystifyfp.com/fsharp/series/fstweet/orchestrating-user-signup/#disqus_thread"></a>
  

  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Orchestrating%20User%20Signup&amp;url=https%3a%2f%2fwww.demystifyfp.com%2ffsharp%2fseries%2ffstweet%2forchestrating-user-signup%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.demystifyfp.com%2ffsharp%2fseries%2ffstweet%2forchestrating-user-signup%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.demystifyfp.com%2ffsharp%2fseries%2ffstweet%2forchestrating-user-signup%2f&amp;title=Orchestrating%20User%20Signup"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fwww.demystifyfp.com%2ffsharp%2fseries%2ffstweet%2forchestrating-user-signup%2f&amp;title=Orchestrating%20User%20Signup"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Orchestrating%20User%20Signup&amp;body=https%3a%2f%2fwww.demystifyfp.com%2ffsharp%2fseries%2ffstweet%2forchestrating-user-signup%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


      <div class="article-style" itemprop="articleBody">
        

<p>Hi,</p>

<p>Welcome back to the seventh part of <a href="/fsharp/series/fstweet/intro/" target="_blank">Creating a Twitter Clone in F# using Suave</a> blog post series.</p>

<p>In this part, we will be orchestrating the user signup use case.</p>

<h2 id="requirements">Requirements</h2>

<p>Before diving into the implementation, let&rsquo;s spend some time to jot down the requirements of the user sign up.</p>

<ol>
<li><p>If the user submitted invalid details, we should let him/her know about the error (which we already implemented in the <a href="/fsharp/series/fstweet/user-signup-validation/" target="_blank">fifth</a> part)</p></li>

<li><p>We also need to check the whether the username or the email provided by the user has been already used by someone else and report it if we found it is not available.</p></li>

<li><p>If all the details are well, then we need to persist the user details with his password hashed and also a randomly generated verification code.</p></li>

<li><p>Then we need to send an email to the provided email address with the verification code.</p></li>

<li><p>Upon receiving an URL with the verification code, the user will be navigating to the provided URL to complete his signup process.</p></li>
</ol>

<p>In this blog post, we are going to implement the <a href="https://lostechies.com/jimmybogard/2008/08/21/services-in-domain-driven-design/" target="_blank">service layer</a> part of the user signup which coordinates the steps two, three and four.</p>

<h2 id="generating-password-hash">Generating Password Hash</h2>

<p>As a first step, let&rsquo;s create the hash for the password provided by the user.</p>

<p>To generate the hash, we are going to use <a href="https://en.wikipedia.org/wiki/Bcrypt" target="_blank">the Bcrypt</a> algorithm. In .NET we can use the <a href="https://github.com/BcryptNet/bcrypt.net" target="_blank">Bcrypt.Net</a> library to create the password hash using the Bcrypt algorithm.</p>

<p>Let&rsquo;s add its NuGet package to our Web project</p>

<pre><code class="language-bash">&gt; forge paket add BCrypt.Net-Next \
    -p src/FsTweet.Web/FsTweet.Web.fsproj
</code></pre>

<p>Then in the <code>Domain</code> module add a new type, <code>PasswordHash</code></p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  open BCrypt.Net
  // ...
  type PasswordHash = private PasswordHash of string with
    member this.Value =
      let (PasswordHash passwordHash) = this
      passwordHash

    static member Create (password : Password) =
      BCrypt.HashPassword(password.Value)
      |&gt; PasswordHash
</code></pre>

<p>As <a href="/fsharp/series/fstweet/user-signup-validation/#making-the-illegal-states-unrepresentable" target="_blank">we did</a> for the other Domain types, <code>PasswordHash</code> has a private constructor function to prevent it from creating from outside.</p>

<p>The static function <code>Create</code> takes care of creating the password hash from the provided password using the <code>Bcrypt</code> library.</p>

<p>The <code>Value</code> property provides the underlying string representation of the <code>PasswordHash</code> type. We will be using while persisting the user details.</p>

<blockquote>
<p>We are placing all the <code>Domain</code> types in <code>UserSignup</code> namespace now. Some of the types that we declared here may be needed for the other use cases. We will be doing the module reorganization when we require it.</p>
</blockquote>

<h2 id="generating-random-verification-code">Generating Random Verification Code</h2>

<p>Like <code>PasswordHash</code>, let&rsquo;s create a domain type for the verification code with a <code>Value</code> property and a static function to create it.</p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  open System.Security.Cryptography
  // ...
  let base64URLEncoding bytes =
    let base64String = 
       System.Convert.ToBase64String bytes
    base64String.TrimEnd([|'='|])
      .Replace('+', '-').Replace('/', '_')

  type VerificationCode = private VerificationCode of string with

    member this.Value =
      let (VerificationCode verificationCode) = this
      verificationCode

    static member Create () =
      let verificationCodeLength = 15
      let b : byte [] = 
        Array.zeroCreate verificationCodeLength
      
      use rngCsp = new RNGCryptoServiceProvider()
      rngCsp.GetBytes(b)

      base64URLEncoding b
      |&gt; VerificationCode 
</code></pre>

<p>We are making use of <a href="https://msdn.microsoft.com/en-us/library/system.security.cryptography.rngcryptoserviceprovider(v=vs.110).aspx" target="_blank">RNGCryptoServiceProvider</a> from the .NET standard library to generate the random bytes and convert them to a string using <a href="https://msdn.microsoft.com/en-us/library/dhx0d524(v=vs.110).aspx" target="_blank">Base64Encoding</a> and making it safer to use in URL as mentioned in <a href="https://stackoverflow.com/a/26354677" target="_blank">this StackOverflow answer</a>.</p>

<h2 id="canonicalizing-username-and-email-address">Canonicalizing Username And Email Address</h2>

<p>To enable the uniqueness check on the <code>Username</code> and the <code>EmailAddress</code> fields, we need to canonicalize both of them.</p>

<p>In our case, trimming the white-space characters and converting to the string to lower case should suffice.</p>

<p>To do it, we can use the existing <code>TryCreate</code> function in the <code>Username</code> and <code>EmailAddress</code> type.</p>

<pre><code class="language-fsharp">type Username = private Username of string with
    static member TryCreate (username : string) =
      match username with
      // ...
      | x -&gt; 
        x.Trim().ToLowerInvariant() 
        |&gt; Username |&gt; ok
    // ...

// ...

type EmailAddress = private EmailAddress of string with
  // ...
  static member TryCreate (emailAddress : string) =
    try 
      // ...
      emailAddress.Trim().ToLowerInvariant() 
      |&gt;  EmailAddress  |&gt; ok
    // ...
</code></pre>

<h2 id="a-type-for-the-create-user-function">A Type For The Create User Function</h2>

<p>We now have both the <code>PasswordHash</code> and the random <code>VerifcationCode</code> in place to persist them along with the canonicalized <code>Username</code> and <code>EmailAddress</code>.</p>

<p>As a first step towards persisting new user details, let&rsquo;s define a type signature for the Create User function that we will be implementing in an upcoming blog post.</p>

<p>First, we need a type to represent the create user request</p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  type CreateUserRequest = {
    Username : Username
    PasswordHash : PasswordHash
    Email : EmailAddress
    VerificationCode : VerificationCode
  }
  // ...
</code></pre>

<p>Then we need to have a type for the response. We will be returning the primary key that has been generated from the PostgreSQL database.</p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  type UserId = UserId of int
  // ...
</code></pre>

<p>As creating a new user is a database operation, things might go wrong. We also need to account the uniqueness check of the <code>Username</code> and the <code>Email</code> properties.</p>

<p>Let&rsquo;s define types for accommodating these scenarios as well.</p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  type CreateUserError =
  | EmailAlreadyExists
  | UsernameAlreadyExists
  | Error of System.Exception
  // ...
</code></pre>

<p>With the help of the types that we declared so far, we can now declare the type for the create user function</p>

<pre><code class="language-fsharp">type CreateUser = 
    CreateUserRequest -&gt; AsyncResult&lt;UserId, CreateUserError&gt;
</code></pre>

<p>The <a href="https://fsprojects.github.io/Chessie/reference/chessie-errorhandling-asyncresult-2.html" target="_blank">AsyncResult</a> type is from the <a href="https://fsprojects.github.io/Chessie/" target="_blank">Chessie</a> library. It represents the <a href="https://fsprojects.github.io/Chessie/reference/chessie-errorhandling-result-2.html" target="_blank">Result</a> of an <a href="https://fsharpforfunandprofit.com/posts/concurrency-async-and-parallel/" target="_blank">asynchronous</a> computation.</p>

<h2 id="a-type-for-the-send-signup-email-function">A Type For The Send Signup Email Function</h2>

<p>Upon creating a new user, we need to send a new signup email to the user. Let&rsquo;s create type for this as we did for <code>CreateUser</code>.</p>

<p>The inputs for this function are <code>Username</code>, <code>EmailAddress</code>, and the <code>VerificationCode</code>.</p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  type SignupEmailRequest = {
    Username : Username
    EmailAddress : EmailAddress
    VerificationCode : VerificationCode
  }
  // ...
</code></pre>

<p>As sending an email may fail, we need to have a type for representing it as well</p>

<pre><code class="language-fsharp">module Domain =
  // ...
  type SendEmailError = SendEmailError of System.Exception
  // ...
</code></pre>

<p>If the email sent successfully, we would be returning <code>unit</code> .</p>

<p>With the help of these two types, we can declare the <code>SendSignupEmail</code> type as</p>

<pre><code class="language-fsharp">module Domain =
  // ...  
  type SendSignupEmail = 
    SignupEmailRequest -&gt; AsyncResult&lt;unit, SendEmailError&gt;
  // ...
</code></pre>

<h2 id="defining-the-signupuser-function-signature">Defining The SignupUser Function Signature</h2>

<p>The <code>SignupUser</code> function makes use of <code>CreateUser</code> and <code>SendSignupEmail</code> functions to complete the user sign up process.</p>

<p>In addition to these two functions, the <code>SignupUser</code> function takes a record of type <code>UserSignupRequest</code> as its input but what about the output?</p>

<pre><code class="language-fsharp">type SignupUser = 
    CreateUser -&gt; SendSignupEmail -&gt; UserSignupRequest 
      -&gt; ???
</code></pre>

<p>There are possible outcomes</p>

<ol>
<li><code>CreateUser</code> may fail</li>
<li><code>SendSignupEmail</code> may fail</li>
<li>User successfully signed up.</li>
</ol>

<p>We can group the two failure conditions into a single type</p>

<pre><code class="language-fsharp">module Domain =
  // ...  
  type UserSignupError =
  | CreateUserError of CreateUserError
  | SendEmailError of SendEmailError
  // ...
</code></pre>

<p>For successful signup, we will be returning a value of type <code>UserId</code>, which we declared earlier.</p>

<pre><code class="language-fsharp">type SignupUser = 
    CreateUser -&gt; SendSignupEmail -&gt; UserSignupRequest 
      -&gt; AsyncResult&lt;UserId, UserSignupError&gt;
</code></pre>

<blockquote>
<p>We are not going to use this <code>SignupUser</code> type anywhere else, and it is just for illustration. In the later blog posts, we&rsquo;ll see how to make use of this kind of type aliases.</p>
</blockquote>

<h2 id="implementing-the-signupuser-function">Implementing The SignupUser Function</h2>

<p>Now we know the inputs and the outputs of the <code>SignupUser</code> function, and it is time to get our hands dirty!</p>

<pre><code class="language-fsharp">module Domain =
  // ...  
  let signupUser (createUser : CreateUser) 
                 (sendEmail : SendSignupEmail) 
                 (req : UserSignupRequest) = asyncTrial {
    // TODO
  }
</code></pre>

<p>Like the <a href="/fsharp/series/fstweet/user-signup-validation/#making-the-illegal-states-unrepresentable" target="_blank">trial</a> computation that we used to do the user signup form validation, the <a href="https://fsprojects.github.io/Chessie/reference/chessie-errorhandling-asynctrial-asynctrialbuilder.html" target="_blank">asyncTrail</a> computation expression is going to help us here to do the error handling in asynchronous operations.</p>

<p>The first step is creating a value of type <code>CreateUserRequest</code> from <code>UserSignupRequest</code></p>

<pre><code class="language-fsharp">let signupUser ... (req : UserSignupRequest) = asyncTrail {
  let createUserReq = {
    PasswordHash = PasswordHash.Create req.Password
    Username = req.Username
    Email = req.EmailAddress
    VerificationCode = VerificationCode.Create()
  }
  // TODO
}
</code></pre>

<blockquote>
<p>The <code>...</code> notation is just a convention that we are using here to avoid repeating the parameters, and it is not part of the fsharp language syntax</p>
</blockquote>

<p>The next step is calling the <code>createUser</code> function with the <code>createUserReq</code></p>

<pre><code class="language-fsharp">let signupUser (createUser : CreateUser) ... = asyncTrail {
  let createUserReq = // ...
  let! userId = createUser createUserReq
  // TODO
}
</code></pre>

<p>Great! We need to send an email now. Let&rsquo;s <code>do</code> it!</p>

<p>Steps involved are creating a value of type <code>SignupEmailRequest</code> and calling the <code>sendEmail</code> function with this value.</p>

<p>As the <code>sendEmail</code> function returning <code>unit</code> on success, we can use the <code>do!</code> notation instead of <code>let!</code></p>

<pre><code class="language-fsharp">let signupUser ... (sendEmail : SendSignupEmail) ... = asyncTrail {
  let createUserReq = // ...
  let! userId = // ...
  let sendEmailReq = {
    Username = req.Username
    VerificationCode = createUserReq.VerificationCode
    EmailAddress = createUserReq.Email
  }
  do! sendEmail sendEmailReq
  // TODO
}
</code></pre>

<p>Now you would be getting a compiler error</p>

<p><img src="/img/fsharp/series/fstweet/bind-error.png" alt="Bind Error" /></p>

<p>Would you be able to find why are we getting this compiler error?</p>

<p>To figure out the solution, let&rsquo;s go back <a href="https://github.com/demystifyfp/FsTweet/blob/v0.4/src/FsTweet.Web/UserSignup.fs#L42-L52" target="_blank">to the TryCreate function</a> in <code>UserSignupRequest</code> type.</p>

<pre><code class="language-fsharp">// ...
with static member TryCreate (username, password, email) =
  trial {
    let! username = Username.TryCreate username
    let! password = Password.TryCreate password
    let! emailAddress = EmailAddress.TryCreate email
    return {
      Username = username
      Password = password
      EmailAddress = emailAddress
    }
  }
</code></pre>

<p>The signature of the <code>TryCreate</code> function is</p>

<pre><code class="language-fsharp">(string, string, string) -&gt; Result&lt;UserSignupRequest, string&gt;
</code></pre>

<p>The signature of the <code>TryCreate</code> function of the Domain types are</p>

<pre><code class="language-fsharp">string -&gt; Result&lt;Username, string&gt;
string -&gt; Result&lt;Password, string&gt;
string -&gt; Result&lt;EmailAddress, string&gt;
</code></pre>

<p>Let&rsquo;s focus our attention to the type that represents the result of a failed computation</p>

<pre><code class="language-fsharp">... -&gt; Result&lt;..., string&gt;
... -&gt; Result&lt;..., string&gt;
... -&gt; Result&lt;..., string&gt;
</code></pre>

<p>All are of <code>string</code> type!</p>

<p>Coming back to the <code>signupUser</code> function what we are implementing, here is a type signature of the functions</p>

<pre><code class="language-fsharp">... -&gt; AsyncResult&lt;..., CreateUserError&gt;
... -&gt; AsyncResult&lt;..., SendEmailError&gt;
</code></pre>

<p>In this case, the types that are representing the failure are of different type. That&rsquo;s thing that we need to fix!</p>

<p><img src="/img/fsharp/series/fstweet/asynctrail-bind-shape.png" alt="Async Trail Output Mismatch" /></p>

<p>If we transform (or map) the failure type to <code>UserSignupError</code>, then things would be fine!</p>

<p><img src="/img/fsharp/series/fstweet/user_signup_map_failure.png" alt="Map Failure" /></p>

<h2 id="mapping-asyncresult-failure-type">Mapping AsyncResult Failure Type</h2>

<blockquote>
<p>You may find this section hard or confusing to get it in the first shot. A recommended approach would be working out the following implementation on your own and use the implementation provided here as a reference. And also if you are thinking of taking a break, this is a right time!</p>
</blockquote>

<p>We already have a union cases which maps <code>CreateUserError</code> and <code>SendEmailError</code> types to <code>UserSignupError</code></p>

<pre><code class="language-fsharp">type UserSignupError =
| CreateUserError of CreateUserError
| SendEmailError of SendEmailError
</code></pre>

<p>These union case identifiers are functions which have the following signature</p>

<pre><code class="language-fsharp">CreateUserError -&gt; UserSignupError
SendEmailError -&gt; UserSignupError
</code></pre>

<p>But we can&rsquo;t use it directly, as the <code>CreateUserError</code> and the <code>SendEmailError</code> are part of the <code>AsyncResult</code> type!</p>

<p>What we want to achieve is mapping</p>

<pre><code class="language-fsharp">AsyncResult&lt;UserId, CreateUserError&gt;
</code></pre>

<p>to</p>

<pre><code class="language-fsharp">AsyncResult&lt;UserId, UserSignupError&gt;
</code></pre>

<p>and</p>

<pre><code class="language-fsharp">AsyncResult&lt;unit, SendEmailError&gt;
</code></pre>

<p>to</p>

<pre><code class="language-fsharp">AsyncResult&lt;unit, UserSignupError&gt;
</code></pre>

<p>Accomplishing this mapping is little tricky.</p>

<p>Let&rsquo;s start our mapping by defining a new function called <code>mapAsyncFailure</code></p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  let mapAsyncFailure f aResult =
    // TODO
</code></pre>

<p>The <code>mapAsyncFailure</code> function is a generic function with the following type signature.</p>

<pre><code class="language-fsharp">'a -&gt; 'b -&gt; AsyncResult&lt;'c, 'a&gt; -&gt; AsyncResult&lt;'c, 'b&gt;
</code></pre>

<p>It takes a function <code>f</code> which maps a type <code>a</code> to <code>b</code> and an <code>AsyncResult</code> as its input. Its output is an <code>AsyncResult</code> with its failure type mapped using the given function <code>f</code>.</p>

<p>The first step to do this mapping is to transform</p>

<pre><code class="language-fsharp">AsyncResult&lt;'c, 'a&gt;
</code></pre>

<p>to</p>

<pre><code class="language-fsharp">Async&lt;Result&lt;'c, 'a&gt;&gt;
</code></pre>

<p>The <code>AsyncResult</code> type is defined in Chessie as a single case discriminated union case <code>AR</code></p>

<pre><code class="language-fsharp">type AsyncResult&lt;'a, 'b&gt; = 
  | AR of Async&lt;Result&lt;'a, 'b&gt;&gt;
</code></pre>

<p>The Chessie library already has a function, <code>ofAsyncResult</code>, to carry out this transformation (or unboxing!)</p>

<pre><code class="language-fsharp">let mapAsyncFailure f aResult =
  aResult
  |&gt; Async.ofAsyncResult 
</code></pre>

<p>The next step is mapping the value that is part of the <code>Async</code> type.</p>

<pre><code class="language-fsharp">Async&lt;'a&gt; -&gt; Async&lt;'b&gt;
</code></pre>

<p>We can again make use of the Chessie library again by using its <code>map</code> function. This map function like other <code>map</code> functions in the fsharp standard module takes a function as its input to do the mapping.</p>

<pre><code class="language-fsharp">'a -&gt; 'b -&gt; Async&lt;'a&gt; -&gt; Async&lt;'b&gt;
</code></pre>

<p>The easier way to understand is to think <code>Async</code> as a box. All mapping function does is takes the value out of the <code>Async</code> box, perform the mapping using the provided function, then put it to back to a new <code>Async</code> box and return it.</p>

<p><img src="/img/fsharp/series/fstweet/async-map.png" alt="Async Map" /></p>

<p>But what is the function that we need to give to the <code>map</code> function to do the mapping</p>

<pre><code class="language-fsharp">let mapAsyncFailure f aResult =
  aResult
  |&gt; Async.ofAsyncResult 
  |&gt; Async.map ???
</code></pre>

<p>We can&rsquo;t give the <code>CreateUserError</code> union case function directly as the <code>f</code> parameter here; it only maps <code>CreateUserError</code> to <code>UserSignupError</code>.</p>

<p>The reason is, the value inside the <code>Async</code> is not <code>CreateUserError</code>, it&rsquo;s <code>Result&lt;UserId, CreateUserError&gt;</code>.</p>

<p>We need to have an another map function which maps the failure part of the <code>Result</code> type</p>

<p><img src="/img/fsharp/series/fstweet/result-map-failure.png" alt="Result Map Failure" /></p>

<p>Let&rsquo;s assume that we have <code>mapFailure</code> function which takes a function <code>f</code> to do this failure type mapping on the <code>Result</code> type.</p>

<p>We can continue with the definition of the <code>mapAsyncFailure</code> function using this <code>mapFailure</code> function.</p>

<pre><code class="language-fsharp">let mapAsyncFailure f aResult =
  aResult
  |&gt; Async.ofAsyncResult 
  |&gt; Async.map (mapFailure f)
</code></pre>

<p>The final step is putting the <code>Async</code> of <code>Result</code> type back to <code>AsyncResult</code> type. As <code>AsyncResult</code> is defined as single case discriminated union, we can use the <code>AR</code> union case to complete the mapping.</p>

<pre><code class="language-fsharp">let mapAsyncFailure f aResult =
  aResult
  |&gt; Async.ofAsyncResult 
  |&gt; Async.map (mapFailure f)
  |&gt; AR
</code></pre>

<p>The <code>mapFailure</code> is not part of the codebase yet. So, Let&rsquo;s add it before going back to the <code>signupUser</code> function.</p>

<p>The Chessie library already has a <code>mapFailure</code> function. But the mapping function parameter maps a list of errors instead of a single error</p>

<pre><code class="language-fsharp">'a list -&gt; 'b list -&gt; Result&lt;'c, 'a list&gt; -&gt; Result&lt;'c, 'b list&gt; 
</code></pre>

<p>The reason for this signature is because the library treats failures as a list in the <code>Result</code> type.</p>

<p>As we are treating the failure in the <code>Result</code> type as a single item, we can&rsquo;t directly make use of it.</p>

<p>However, we can leverage it to fit our requirement by having an implementation, which takes the first item from the failure list, call the mapping function and then create a list from the output of the map function.</p>

<pre><code class="language-fsharp">// UserSignup.fs
module Domain =
  // ...
  let mapFailure f aResult = 
    let mapFirstItem xs = 
      List.head xs |&gt; f |&gt; List.singleton 
    mapFailure mapFirstItem aResult
  // ...
</code></pre>

<p>This <code>mapFailure</code> function has the signature</p>

<pre><code class="language-fsharp">'a -&gt; 'b -&gt; Result&lt;'c, 'a&gt; -&gt; Result&lt;'c, 'b&gt; 
</code></pre>

<p>With this, we are done with the mapping of <code>AsyncResult</code> failure type.</p>

<h2 id="going-back-to-the-signupuser-function">Going Back To The signupUser Function</h2>

<p>In the previous section, we implemented a solution to fix the compiler error that we encountered while defining the <code>signupUser</code> function.</p>

<p>With the <code>mapAsyncFailure</code> function, we can rewrite the <code>signupUser</code> function to transform the error type and return the <code>UserId</code> if everything goes well.</p>

<pre><code class="language-fsharp">module Domain =
  // ...
  let signupUser ...= asyncTrial {
    
    let createUserReq = // ...
    let! userId = 
      createUser createUserReq
      |&gt; mapAsyncFailure CreateUserError
    let sendEmailReq = // ...
    do! sendEmail sendEmailReq 
        |&gt; mapAsyncFailure SendEmailError

    return userId
  }
</code></pre>

<p>That&rsquo;s it!!</p>

<h2 id="summary">Summary</h2>

<p>One of the key take away of this blog post is how we can solve a complex problem in fsharp by just focusing on the function signature.</p>

<p>We also learned how to compose functions together, transforming the values using the map function to come up with a robust implementation.</p>

<p>The source code is available on the <a href="https://github.com/demystifyfp/FsTweet/tree/v0.6" target="_blank">GitHub Repository</a></p>

<h3 id="next-part">Next Part</h3>

<p><a href="/fsharp/series/fstweet/transforming-async-result-to-webpart/" target="_blank">Transforming Async Result to Webpart</a></p>

      </div>

      


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/chessie">Chessie</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/rop">rop</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/fsharp">fsharp</a>
  
</div>



    </div>
  </div>

</article>



<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/fsharp/series/fstweet/user-signup-validation/">Validating New User Signup Form</a></li>
    
    <li><a href="/fsharp/series/fstweet/db-migration-setup/">Setting Up Database Migration</a></li>
    
    <li><a href="/fsharp/series/fstweet/user-signup/">Handling User signup Form</a></li>
    
    <li><a href="/fsharp/series/fstweet/static-assets/">Serving Static Asset Files</a></li>
    
    <li><a href="/fsharp/series/fstweet/dotliquid-setup/">Setting Up Server Side Rendering using DotLiquid</a></li>
    
  </ul>
</div>




<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "demystifyfp" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Demystify FP &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    
    <script id="dsq-count-scr" src="//demystifyfp.disqus.com/count.js" async></script>
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    
    <script src="/js/custom.js"></script>
    

    
    
      
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
      

      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/fsharp.min.js"></script>
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/diff.min.js"></script>
      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

