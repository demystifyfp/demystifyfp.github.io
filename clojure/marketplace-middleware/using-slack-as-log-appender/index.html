<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.53" />
  
  <meta name="description" content="Demystifying">

  
  <link rel="alternate" hreflang="en-us" href="https://www.demystifyfp.com/clojure/marketplace-middleware/using-slack-as-log-appender/">

  
  


  

  
  
  
  
    
  
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.1/css/academicons.min.css" integrity="sha512-NThgw3XKQ1absAahW6to7Ey42uycrVvfNfyjqcFNgCmOCQ5AR4AO0SiXrN+8ZtYeappp56lk1WtvjVmEa+VR6A==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Montserrat:400,700%7cRoboto:400,400italic,700%7cRoboto&#43;Mono">
  
  <link rel="stylesheet" href="/styles.css">
  
  <link rel="stylesheet" href="/css/custom.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-111185766-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  
  <link rel="alternate" href="https://www.demystifyfp.com/index.xml" type="application/rss+xml" title="Demystify FP">
  <link rel="feed" href="https://www.demystifyfp.com/index.xml" type="application/rss+xml" title="Demystify FP">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://www.demystifyfp.com/clojure/marketplace-middleware/using-slack-as-log-appender/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@demystifyfp">
  <meta property="twitter:creator" content="@demystifyfp">
  
  <meta property="og:site_name" content="Demystify FP">
  <meta property="og:url" content="https://www.demystifyfp.com/clojure/marketplace-middleware/using-slack-as-log-appender/">
  <meta property="og:title" content="Using Slack as Log Appender | Demystify FP">
  <meta property="og:description" content="">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2019-10-06T20:25:41&#43;05:30">
  
  <meta property="article:modified_time" content="2019-10-06T20:25:41&#43;05:30">
  

  
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/4132543.js"></script>


<meta name="flattr:id" content="qjy9np">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
  Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.16.0/components/'
</script>

  <title>Using Slack as Log Appender | Demystify FP</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71" >

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="/">Demystify FP</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
            Posts
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            
            <li class="nav-item">
              <a href="/#fsharp-posts">
                
                <span>F#</span>
              </a>
            </li>
            
            <li class="nav-item">
              <a href="/#clojure-posts">
                
                <span>Clojure</span>
              </a>
            </li>
            
          </ul>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#books">
            
            <span>Books</span>
          </a>
        </li>

        
        

        
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
            Courses
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu">
            
            <li class="nav-item">
              <a href="https://www.udemy.com/learn-suave/?couponCode=DEMYSTIFY_FP">
                
                <span>MiniSuave in F#</span>
              </a>
            </li>
            
          </ul>
        </li>

        
        

        

        <li class="nav-item">
          <a href="https://www.codementor.io/tamizhvendan">
            
            <span>Get 1:1 Help</span>
          </a>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <div class="article-inner">
      <h1 itemprop="name">Using Slack as Log Appender</h1>
      <div>


<div class="article-tags">
  
  <a class="btn btn-primary btn-outline" href="/tags/clojure">clojure</a>
  
  <a class="btn btn-primary btn-outline" href="/tags/timbre">Timbre</a>
  
</div>


</div>
      

<div class="article-metadata">

  <span class="article-date">
    
    <time datetime="2019-10-06 20:25:41 &#43;0530 IST" itemprop="datePublished">
      Sun, Oct 6, 2019
    </time>
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  
  <span class="middot-divider"></span>
  <a href="https://www.demystifyfp.com/clojure/marketplace-middleware/using-slack-as-log-appender/#disqus_thread"></a>
  

  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Using%20Slack%20as%20Log%20Appender&amp;url=https%3a%2f%2fwww.demystifyfp.com%2fclojure%2fmarketplace-middleware%2fusing-slack-as-log-appender%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.demystifyfp.com%2fclojure%2fmarketplace-middleware%2fusing-slack-as-log-appender%2f"
         target="_blank" rel="noopener">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.demystifyfp.com%2fclojure%2fmarketplace-middleware%2fusing-slack-as-log-appender%2f&amp;title=Using%20Slack%20as%20Log%20Appender"
         target="_blank" rel="noopener">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fwww.demystifyfp.com%2fclojure%2fmarketplace-middleware%2fusing-slack-as-log-appender%2f&amp;title=Using%20Slack%20as%20Log%20Appender"
         target="_blank" rel="noopener">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Using%20Slack%20as%20Log%20Appender&amp;body=https%3a%2f%2fwww.demystifyfp.com%2fclojure%2fmarketplace-middleware%2fusing-slack-as-log-appender%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>



      <div class="article-style" itemprop="articleBody">
        

<p>The back-office team of our client has an active slack based workflow for most of their systems. As this middleware is going to be another system that they need to keep track of, they asked us to send messages on Slack if the middleware encounters an error during its operation. In this blog post, I am going to share how we did it in Clojure using Timbre.</p>

<blockquote>
<p>This blog post is a part 5 of the blog series <a href="/clojure/marketplace-middleware/intro/" target="_blank">Building an E-Commerce Marketplace Middleware in Clojure</a>.</p>
</blockquote>

<h3 id="slack-incoming-webhooks">Slack Incoming Webhooks</h3>

<p>Slack has the mechanism of <a href="https://api.slack.com/incoming-webhooks" target="_blank">Incoming Webhooks</a> that provides a simple way to post messages from any application into Slack. By following <a href="https://api.slack.com/incoming-webhooks#getting-started" target="_blank">these steps</a>, we will get a unique <em>webhook</em> URL to which we can send a JSON payload with the message text and some other options.</p>

<h3 id="sending-a-slack-message">Sending A Slack Message</h3>

<p>To work with the HTTP post requests, let&rsquo;s add <a href="https://github.com/dakrone/clj-http" target="_blank">clj-http</a> dependency in our <em>project.clj</em> and restart the REPL.</p>

<pre><code class="language-clojure">(defproject wheel &quot;0.1.0-SNAPSHOT&quot;
  ; ...
  :dependencies [; ...
                 [clj-http &quot;3.10.0&quot;]]
  ; ...
  )
</code></pre>

<p>Then create a new directory <em>slack</em> and a Clojure file <em>webhook.clj</em> under it.</p>

<pre><code class="language-bash">&gt; mkdir src/wheel/slack
&gt; touch src/wheel/slack/webhook.clj
</code></pre>

<p>Finally, create a function <code>post-message!</code> to post a message in a Slack channel using the webhook URL.</p>

<pre><code class="language-clojure">; src/wheel/slack/webhook.clj
(ns wheel.slack.webhook
  (:require [clj-http.client :as http]
            [cheshire.core :as json]))

(defn post-message! [webhook-url text attachments]
  (let [body (json/generate-string {:text text
                                    :attachments attachments})]
    (http/post webhook-url {:content-type :json
                            :body body})))
</code></pre>

<p>Let&rsquo;s try to execute this function in the REPL</p>

<pre><code class="language-clojure">wheel.slack.webhook=&gt; (post-message! &quot;{{webhook-url}}&quot;
                                     &quot;ranging failed&quot;
                                     [{:color :danger
                                       :fields [{:title &quot;Channel Name&quot;
                                                 :value :tata-cliq
                                                 :short true}
                                                {:title &quot;Channel Id&quot;
                                                 :value &quot;UA&quot;
                                                 :short true}
                                                {:title &quot;Event Id&quot;
                                                 :value &quot;2f763cf7-d5d7-492c-a72d-4546bb547696&quot;}]}])
{:body &quot;ok&quot;
 ; ...
 }
</code></pre>

<p>We should see something similar to this in the configured slack channel.</p>

<p><img src="/img/clojure/blog/ecom-middleware/sample-slack-event.png" alt="" /></p>

<h3 id="updating-application-config">Updating Application Config</h3>

<p>To pass the slack&rsquo;s webhook URL to the application, let&rsquo;s update the <em>resources/config.edn</em>.</p>

<pre><code class="language-clojure">{:app
  {:database {...}
   :log {:slack {:webhook-url #env &quot;WHEEL_APP_LOG_SLACK_WEBHOOK_URL&quot;}}}}
</code></pre>

<p>Then add the wrapper function in the <em>infra/config.clj</em></p>

<pre><code class="language-clojure">; src/wheel/infra/config.clj
; ...
(defn slack-log-webhook-url []
  (get-in root [:app :log :slack :webhook-url]))
</code></pre>

<p>To verify this new config, stop the REPL, set the environment variable <code>WHEEL_APP_LOG_SLACK_WEBHOOK_URL</code> with the webhook URL and start the REPL. Then start the app, call the <code>slack-log-webhook-url</code> function.</p>

<pre><code class="language-clojure">wheel.core=&gt; (in-ns 'user)
#&lt;clojure.lang.Namespace@13250e3 user&gt;
user=&gt; (start-app)
{:started [...]}
user=&gt; (wheel.infra.config/slack-log-webhook-url)
&quot;https://hooks.slack.com/services/....&quot;
</code></pre>

<p>All right! Now we have the infrastructure in place to send messages to Slack, and it&rsquo;s time to wire it up with Timbre.</p>

<h3 id="adding-slack-appender">Adding Slack Appender</h3>

<p>As we did for the <code>database</code> appender, let&rsquo;s create a new file <em>slack.clj</em> under <em>infra/log_appender</em></p>

<pre><code class="language-bash">&gt; touch src/infra/log_appender/slack.clj
</code></pre>

<p>Then add two helper function to transform the events into slack text and attachment.</p>

<pre><code class="language-clojure">; src/infra/log_appender/slack.clj
(ns wheel.infra.log-appender.slack
  (:require [wheel.slack.webhook :as slack]
            [wheel.infra.config :as config]))

(defn- event-&gt;text [{event-name :name}]
  (str (namespace event-name) &quot; &quot; (name event-name)))

(defn- event-&gt;attachment [{:keys [id channel-id channel-name]}]
  {:color :danger
   :fields [{:title &quot;Channel Name&quot;
             :value channel-name
             :short true}
            {:title &quot;Channel Id&quot;
             :value channel-id
             :short true}
            {:title &quot;Event Id&quot;
             :value id}]})
</code></pre>

<pre><code class="language-clojure">wheel.infra.log-appender.slack==&gt; (event-&gt;text {:name :ranging/failed})
&quot;ranging failed&quot;
</code></pre>

<p>The actual appender function uses these functions and posts the message using the <code>post-message!</code> function that we defined earlier.</p>

<pre><code class="language-clojure">; src/infra/log_appender/slack.clj
; ...

(defn- send-to-slack [{:keys [msg_]}]
  (let [event (read-string (force msg_))]
    (when (= :domain (:type event))
      (let [text (event-&gt;text event)
            attachment (event-&gt;attachment event)
            webhook-url (config/slack-log-webhook-url)]
        (slack/post-message! webhook-url text [attachment])))))

(def appender {:enabled? true
               :output-fn :inherit
               :async? true
               :min-level :error
               :fn send-to-slack})
</code></pre>

<p>Unlike the <code>database</code> appender, the <code>slack</code> one going to process only the logs with the level <code>:error</code> or above.</p>

<p>The final step is adding this appender to the Timbre&rsquo;s config.</p>

<pre><code class="language-clojure">(ns wheel.infra.log
  (:require ; ...
            [wheel.infra.log-appender.slack :as slack]))

; ...

(defn init []
  (timbre/merge-config! {; ...
                         :appenders { ;...
                                     :slack slack/appender}}))

; ...
</code></pre>

<p>If we reset the application in the REPL, and write an error log using the <code>write!</code> function, we should be able to see the log entry (event) both in the slack and in the database.</p>

<h2 id="summary">Summary</h2>

<p>In this blog post, we started from where we left off in the previous post and added the new <code>slack</code> appender. Working with Timber for logging is such a pleasant experience. We are one more step closer in setting up the infrastructure aspects of the application. Stay tuned!</p>

<p>The source code associated with this part is available on <a href="https://github.com/demystifyfp/BlogSamples/tree/0.17/clojure/wheel" target="_blank">this GitHub</a> repository.</p>

      </div>

    </div>
  </div>


  </div>


</article>





<div class="article-container article-widget">
  <div class="hr-light"></div>
  <h3>Related</h3>
  <ul>
    
    <li><a href="/clojure/marketplace-middleware/storing-log-events-in-postgres-using-toucan/">Storing Log Events in Postgres Using Toucan</a></li>
    
    <li><a href="/clojure/marketplace-middleware/configuring-logging-using-timbre/">Configuring Logging Using Timbre</a></li>
    
    <li><a href="/clojure/marketplace-middleware/configuring-database-connection-pooling-migration-reloaded-workflow/">Configuring Database Connection Pooling, Migration and Reloaded Workflow</a></li>
    
    <li><a href="/clojure/marketplace-middleware/bootstrapping-clojure-project-using-mount-and-aero/">Bootstrapping Clojure Project Using Mount And Aero</a></li>
    
    <li><a href="/clojure/marketplace-middleware/intro/">Building an E-Commerce Marketplace Middleware in Clojure</a></li>
    
  </ul>
</div>




<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "demystifyfp" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2017 Demystify FP &middot; 

      Powered by the
      <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
      <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close btn-large" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Cite</h4>
      </div>
      <div>
        <pre><code class="modal-body tex"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-primary btn-outline js-copy-cite" href="#" target="_blank">
          <i class="fa fa-copy"></i> Copy
        </a>
        <a class="btn btn-primary btn-outline js-download-cite" href="#" target="_blank">
          <i class="fa fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    
    <script id="dsq-count-scr" src="//demystifyfp.disqus.com/count.js" async></script>
    

    

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha512-3P8rXCuGJdNZOnUx/03c1jOTnMn3rP63nBip5gOP2qmUh5YAdVAvFZ1E+QLZZbC1rtMrQb+mah3AfYW11RUrWA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    
    <script src="/js/hugo-academic.js"></script>
    
    <script src="/js/custom.js"></script>
    

    
    

    
    

  </body>
</html>
